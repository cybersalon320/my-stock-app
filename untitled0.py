# -*- coding: utf-8 -*-
"""Untitled0.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1UUhvDtALfTrE5QbiFrPeeWc3BaCXcU1p
"""

import streamlit as st
import yfinance as yf
import pandas_ta as ta
import pandas as pd
import plotly.graph_objects as go
from datetime import datetime
import pytz

# è¨­å®šç¶²é æ¨™é¡Œèˆ‡åœ–ç¤º
st.set_page_config(page_title="2026 AI è‚¡åƒ¹åµæ¸¬å¼•æ“", layout="wide")

# --- å´é‚Šæ¬„ï¼šåƒæ•¸è¨­å®š ---
st.sidebar.header("âš™ï¸ åµæ¸¬åƒæ•¸è¨­å®š")
stock_list = st.sidebar.text_input("è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ (å¤šæ”¯è«‹ç”¨é€—è™Ÿéš”é–‹)", "1301.TW, 1303.TW, 2408.TW, 8046.TW, 2330.TW")
rsi_period = st.sidebar.slider("RSI å¤©æ•¸", 5, 30, 14)
vol_factor = st.sidebar.slider("é‡å¢å€æ•¸é–€æª»", 1.0, 5.0, 2.5)

# --- ä¸»ç•«é¢ï¼šæ¨™é¡Œèˆ‡æ™‚é–“ ---
tw_tz = pytz.timezone('Asia/Taipei')
now = datetime.now(tw_tz)

st.title("ğŸš€ å°ˆæ¥­ç´šå¼·å‹¢çªç ´åµæ¸¬ç³»çµ±")
col_time1, col_time2 = st.columns(2)
col_time1.metric("ğŸ“… åµæ¸¬æ—¥æœŸ", now.strftime('%Y-%m-%d'))
col_time2.metric("â° å°åŒ—æ™‚é–“", now.strftime('%H:%M:%S'))

st.markdown("---")

# --- æ ¸å¿ƒé‚è¼¯ ---
stocks = [s.strip() for s in stock_list.split(",")]

if st.button("ğŸ” é–‹å§‹å…¨é‡æƒæ"):
    for symbol in stocks:
        with st.expander(f"ğŸ“Š æª¢æŸ¥ {symbol} çš„è©³ç´°åˆ†æ", expanded=True):
            try:
                # æŠ“å–æ•¸æ“š
                df = yf.download(symbol, period="60d", interval="1d", progress=False)
                if df.empty:
                    st.error(f"æ‰¾ä¸åˆ° {symbol} çš„æ•¸æ“š")
                    continue

                # æŒ‡æ¨™è¨ˆç®—
                df['RSI'] = ta.rsi(df['Close'].squeeze(), length=rsi_period)
                avg_vol = df['Volume'].iloc[-6:-1].mean().values[0]
                curr_vol = df['Volume'].iloc[-1].values[0]
                curr_price = df['Close'].iloc[-1].values[0]
                vol_ratio = curr_vol / avg_vol

                # é¡¯ç¤ºæ•¸æ“šå¡ç‰‡
                c1, c2, c3 = st.columns(3)
                c1.metric("ç›®å‰è‚¡åƒ¹", f"{curr_price:.2f}")
                c2.metric("æˆäº¤é‡å€æ•¸", f"{vol_ratio:.2f}x", delta=f"{vol_ratio-1:.2f}")
                c3.metric("RSI æŒ‡æ•¸", f"{df['RSI'].iloc[-1]:.1f}")

                # åˆ¤å®šç‹€æ…‹
                if vol_ratio >= vol_factor:
                    st.success(f"ğŸš© è¨Šè™Ÿç¢ºèªï¼š{symbol} å‡ºç¾çˆ†é‡çªç ´ï¼")
                else:
                    st.info(f"âšª {symbol} è¶¨å‹¢å°šåœ¨æ•´ç†ä¸­ã€‚")

# ç¹ªè£½ K ç·šåœ–
                fig = go.Figure(data=[go.Candlestick(x=df.index,
                                open=df['Open'], high=df['High'],
                                low=df['Low'], close=df['Close'], name='Kç·š')])
                fig.update_layout(height=400, margin=dict(l=0, r=0, t=0, b=0))
                st.plotly_chart(fig, use_container_width=True)
                
            except Exception as e:
                st.warning(f"åˆ†æ {symbol} æ™‚å‡ºéŒ¯: {e}")

st.sidebar.markdown("---")
st.sidebar.write("ğŸ’¡ æç¤ºï¼šè¼¸å…¥ä»£è™Ÿè«‹åŠ  .TW (å°è‚¡)")
